<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="joint.css" />
    <link rel="stylesheet" href="style.css" />
    <script src="jquery.js"></script>
    <script src="lodash.js"></script>
    <script src="backbone.js"></script>
    <script src="joint.js"></script>
</head>
<body>
<div id="myholder">
</div>
<script type="text/javascript">

    var graph = new joint.dia.Graph;
    var paper = new joint.dia.Paper({ el: $('#myholder'), width: 1200, height: 700, gridSize: 1, model: graph });

    var elementWidth = 230;
    var elementHeight = 114;

    // Create a custom element.
    // ------------------------

    joint.shapes.html = {};
    joint.shapes.html.Element = joint.shapes.basic.Rect.extend({
        defaults: joint.util.deepSupplement({
            type: 'html.Element',
            attrs: {
                rect: { fill: '#3498DB', rx: 5, ry: 5, 'stroke-width': 4, stroke: '#3498DB',
                    'border-radius': '4px', border: '2px solid #2980B9',
                    'box-shadow': 'inset 0 0 5px black, 2px 2px 1px grey'
                }
            }
        }, joint.shapes.basic.Rect.prototype.defaults)
    });

    // Create a custom view for that element that displays an HTML div above it.
    // -------------------------------------------------------------------------

    joint.shapes.html.ElementView = joint.dia.ElementView.extend({

        template: [
            '<div class="html-element">',
                '<button class="delete">x</button>',
                '<input class="inputTitle" id="inputTitle" name="inputTitle" type="text"/> </br>',

            // labels
                '<label>Min time | Est time | Max time | Dur</label>',

            // input fields for PERT
                '<input class="pertInput" id="minTime" type="number" />',
                '<input class="pertInput" id="estTime" type="number" />',
                '<input class="pertInput" id="maxTime" type="number" />',
                '<input class="duration" id="duration" type="number" />',

            // results
                '<label>Early start | finish | Late start | finish</label>',
                '<input class="cpmResult" id="earlyStart" type="number" />',
                '<input class="cpmResult" id="earlyFinish" type="number" />',
                '<input class="cpmResult" id="lateStart" type="number" />',
                '<input class="cpmResult" id="lateFinish" type="number" />',
            '</div>'
        ].join(''),

        // 1 2 3 2 -|- 1 2 6 2 -|- 2 4 6 4
        // 2 4 10 4

        initialize: function() {
            _.bindAll(this, 'updateBox');
            joint.dia.ElementView.prototype.initialize.apply(this, arguments);
            this.$box = $(_.template(this.template)());

            // title
            this.$box.find('#inputTitle').on('change', _.bind(function(evt) {
                this.model.set('inputTitle', $(evt.target).val());
            }, this));

            // PERT input
            this.$box.find('#minTime').on('change', _.bind(function(evt) {
                this.model.set('minTime', $(evt.target).val());
            }, this));

            this.$box.find('#estTime').on('change', _.bind(function(evt) {
                this.model.set('estTime', $(evt.target).val());
            }, this));

            this.$box.find('#maxTime').on('change', _.bind(function(evt) {
                this.model.set('maxTime', $(evt.target).val());
            }, this));

            // duration
            this.$box.find('#duration').on('change', _.bind(function(evt) {
                this.model.set('duration', $(evt.target).val());
            }, this));

            // CPM results
            this.$box.find('#earlyStart').on('change', _.bind(function(evt) {
                this.model.set('earlyStart', $(evt.target).val());
            }, this));

            this.$box.find('#earlyFinish').on('change', _.bind(function(evt) {
                this.model.set('earlyFinish', $(evt.target).val());
            }, this));

            this.$box.find('#lateStart').on('change', _.bind(function(evt) {
                this.model.set('lateStart', $(evt.target).val());
            }, this));

            this.$box.find('#lateFinish').on('change', _.bind(function(evt) {
                this.model.set('lateFinish', $(evt.target).val());
            }, this));

            this.$box.find('.html-element').on('change', _.bind(function(evt) {
                this.model.set('class', $(evt.target).val());
            }, this));

            this.$box.find('.delete').on('click', _.bind(this.model.remove, this.model));
            // Update the box position whenever the underlying model changes.
            this.model.on('change', this.updateBox, this);
            // Remove the box when the model gets removed from the graph.
            this.model.on('remove', this.removeBox, this);

            this.updateBox();
        },
        render: function() {
            joint.dia.ElementView.prototype.render.apply(this, arguments);
            this.paper.$el.prepend(this.$box);
            this.updateBox();
            return this;
        },
        updateBox: function() {
            // Set the position and dimension of the box so that it covers the JointJS element.
            var bbox = this.model.getBBox();

            this.$box.find('#inputTitle').val(this.model.get('inputTitle'));
            this.$box.find('#minTime').val(this.model.get('minTime'));
            this.$box.find('#estTime').val(this.model.get('estTime'));
            this.$box.find('#maxTime').val(this.model.get('maxTime'));
            this.$box.find('#duration').val(this.model.get('duration'));
            this.$box.find('#earlyStart').val(this.model.get('earlyStart'));
            this.$box.find('#earlyFinish').val(this.model.get('earlyFinish'));
            this.$box.find('#lateStart').val(this.model.get('lateStart'));
            this.$box.find('#lateFinish').val(this.model.get('lateFinish'));
            this.$box.find('.html-element').val(this.model.get('class'));

            this.$box.css({
                width: bbox.width,
                height: bbox.height,
                left: bbox.x,
                top: bbox.y,
                transform: 'rotate(' + (this.model.get('angle') || 0) + 'deg)'
            });
        },
        removeBox: function(evt) {
            this.$box.remove();
        }
    });

    // Create JointJS elements and add them to the graph as usual.
    // -----------------------------------------------------------

    var el1 = new joint.shapes.html.Element({
        position: { x: 40, y: 150 },
        size: { width: elementWidth, height: elementHeight },
        attrs: { text: { magnet: true } },
        inputTitle: 'Title 1',
        minTime: 1,
	estTime: 2,
	maxTime: 4
    });

    var el2 = new joint.shapes.html.Element({
        position: { x: 320, y: 40 },
        size: { width: elementWidth, height: elementHeight },
        attrs: { text: { magnet: true } },
        inputTitle: 'Title 2',
        minTime: 2,
	estTime: 4,
	maxTime: 6
    });

    var el3 = new joint.shapes.html.Element({
        position: { x: 320, y: 340 },
        size: { width: elementWidth, height: elementHeight },
        attrs: { text: { magnet: true } },
        inputTitle: 'Title 3',
        minTime: 2,
	estTime: 5,
	maxTime: 12
    });

    var el4 = new joint.shapes.html.Element({
        position: { x: 580, y: 150 },
        size: { width: elementWidth, height: elementHeight },
        attrs: { text: { magnet: true } },
        inputTitle: 'Title 4',
        minTime: 2,
	estTime: 4,
	maxTime: 5
    });

    var l12 = new joint.dia.Link({
        source: { id: el1.id },
        target: { id: el2.id },
        attrs: { '.connection': { 'stroke-width': 5, stroke: '#34495E' },'.marker-target': { d: 'M 10 0 L 0 5 L 10 10 z' }  }
    });

    var l13 = new joint.dia.Link({
        source: { id: el1.id },
        target: { id: el3.id },
        attrs: { '.connection': { 'stroke-width': 5, stroke: '#34495E' },'.marker-target': { d: 'M 10 0 L 0 5 L 10 10 z' }  }
    });

    var l34 = new joint.dia.Link({
        source: { id: el3.id },
        target: { id: el4.id },
        attrs: { '.connection': { 'stroke-width': 5, stroke: '#34495E' },'.marker-target': { d: 'M 10 0 L 0 5 L 10 10 z' }  }
    });

    var l24 = new joint.dia.Link({
        source: { id: el2.id },
        target: { id: el4.id },
        attrs: { '.connection': { 'stroke-width': 5, stroke: '#34495E' },'.marker-target': { d: 'M 10 0 L 0 5 L 10 10 z' }  }
    });

    graph.addCells([el1, el2, el3, el4, l12, l13, l24, l34]);

    // add connection on double click
    paper.on('cell:pointerdblclick', function(cellView) {

        var connection = new joint.dia.Link({
            source: { id: cellView.model.id },
            attrs: { '.connection': { 'stroke-width': 5, stroke: '#34495E' },'.marker-target': { d: 'M 10 0 L 0 5 L 10 10 z' }  }
        });

        graph.addCells([connection]);

    });

    function addElement () {
        var el = new joint.shapes.html.Element({
            position: { x: 80, y: 80 },
            size: { width: elementWidth, height: elementHeight },
            inputTitle: 'Title'
        });

        graph.addCells([el]);
    }

    function getCriticalPath () {
        $.ajax({
            type: "POST",
            //dataType: "application/json",
            contentType: "application/json",
            data: getElementsAsJSON(),
            url: "http://rzipas.win:8090/criticalPath",
            success: function(data){
                data.forEach(function(result) {
                    var element = graph.getCell(result.id);

                    if(result.isCriticalPath == 1){

                        element.attr({
                            rect: { fill: '#ff100a', rx: 5, ry: 5, 'stroke-width': 4, stroke: 'red' }
                        });

                        //element.toggleClass('html-element-criticalPath');
                    }

                    element.set('earlyStart', result.earlyStart);
                    element.set('lateStart', result.lateStart);
                    element.set('earlyFinish', result.earlyFinish);
                    element.set('lateFinish', result.lateFinish);

                });
            },
            error: function(xhr, status, error) {
                var err = eval("(" + xhr.responseText + ")");
                alert(err.message);
            }
            });
    }

    function getPERTValues () {

        $.ajax({
            type: "POST",
            //dataType: "application/json",
            contentType: "application/json",
            data: getElementsAsJSON(),
            url: "http://rzipas.win:8090/pert",
            success: function(data){
                data.forEach(function(result) {
                    var element = graph.getCell(result.id);
                    element.set('duration', result.duration);
                });
            },
            error: function(xhr, status, error) {
                var err = eval("(" + xhr.responseText + ")");
                alert(err.message);
            }
        });
    }

    function getElementsAsJSON(){
        var text = JSON.stringify(graph);

        text = text.substr(text.indexOf("["),text.lastIndexOf("]") - text.indexOf("[") + 1);
        document.getElementById("result").innerText = text;
        return text;
    }
</script>

<button type="button" onclick="addElement()">Add element</button>
<button type="button" onclick="getCriticalPath()">Get critical path</button>
<button type="button" onclick="getPERTValues()">Get PERT values</button>

<p id="result"></p>
</body>
</html>